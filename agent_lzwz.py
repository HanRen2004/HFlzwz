import streamlit as st
import requests
import uuid
import dashscope
from langchain.chains import LLMChain
from langchain.memory import ConversationBufferMemory
from langchain.tools import tool
from langchain_community.llms.tongyi import Tongyi
import os
from langchain.agents import initialize_agent, AgentType, Tool
from langchain_core.prompts import PromptTemplate
from openai import OpenAI
from langchain_openai import ChatOpenAI
from flask import Flask, request, jsonify
from streamlit.components.v1 import html
import base64
import threading
import time

# È°µÈù¢ÈÖçÁΩÆ
st.set_page_config(page_title="Âä±ÂøóÊñáÁ´†Êé®Ëçê", page_icon="üìñ")

# Ëá™ÂÆö‰πâ CSS Ê†∑Âºè
custom_css = """
<style>
    /* È°µÈù¢ËÉåÊôØÂíåÂÖ®Â±ÄÊ†∑Âºè */
    .stApp {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        background-size: 400% 400%;
        animation: gradientBG 15s ease infinite;
    }
    
    @keyframes gradientBG {
        0% { background-position: 0% 50% }
        50% { background-position: 100% 50% }
        100% { background-position: 0% 50% }
    }
    
    /* Ê†áÈ¢òÊ†∑Âºè */
    h1 {
        font-size: 3rem;
        font-weight: 700;
        color: #FF6B6B;
        text-align: center;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 10px;
        background: linear-gradient(90deg, #FF6B6B, #FFD166, #06D6A0);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: rainbow 6s ease infinite;
    }

    @keyframes rainbow { 
        0%{background-position:0% 50%}
        50%{background-position:100% 50%}
        100%{background-position:0% 50%}
    }

    h2 {
        font-size: 1.7rem;
        color: #4A90E2;
        text-align: center;
        margin-bottom: 30px;
        font-family: 'Arial', sans-serif;
        font-style: italic;
        letter-spacing: 1px;
    }

    /* Ë£ÖÈ•∞ÂÖÉÁ¥† */
    .stApp::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4MDAiIGhlaWdodD0iNjAwIiB2aWV3Qm94PSIwIDAgODAwIDYwMCI+CiAgPGRlZnM+CiAgICA8bGluZWFyR3JhZGllbnQgaWQ9ImdyYWQxIiB4MT0iMCUiIHkxPSIwJSIgeDI9IjEwMCUiIHkyPSIxMDAlIj4KICAgICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3R5bGU9InN0b3AtY29sb3I6I0ZGNkI2QjtzdG9wLW9wYWNpdHk6MC42IiAvPgogICAgICA8c3RvcCBvZmZzZXQ9IjUwJSIgc3R5bGU9InN0b3AtY29sb3I6I0ZGRDk2NjtzdG9wLW9wYWNpdHk6MC40IiAvPgogICAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiMwNkQ2QTA7c3RvcC1vcGFjaXR5OjAuNSIgLz4KICAgIDwvbGluZWFyR3JhZGllbnQ+CiAgICA8ZmlsdGVyIGlkPSJibHVyIiB4PSItNTAlIiB5PSItNTAlIiB3aWR0aD0iMjAwJSIgaGVpZ2h0PSIyMDAlIj4KICAgICAgPGZlR2F1c3NpYW5CbHVyIGluPSJTb3VyY2VHcmFwaGljIiBzdGREZXZpYXRpb249IjMwIiAvPgogICAgPC9maWx0ZXI+CiAgPC9kZWZzPgogIDxjaXJjbGUgY3g9IjIwMCIgY3k9IjE1MCIgcj0iODAiIGZpbGw9IiNGRkQ5NjYiIG9wYWNpdHk9IjAuNCIgZmlsdGVyPSJ1cmwoI2JsdXIpIj4KICAgIDxhbmltYXRlIGF0dHJpYnV0ZU5hbWU9InIiIHZhbHVlcz0iODA7OTU7ODAiIGR1cj0iOHMiIHJlcGVhdENvdW50PSJpbmRlZmluaXRlIiAvPgogICAgPGFuaW1hdGUgYXR0cmlidXRlTmFtZT0ib3BhY2l0eSIgdmFsdWVzPSIwLjQ7MC42OzAuNCIgZHVyPSI4cyIgcmVwZWF0Q291bnQ9ImluZGVmaW5pdGUiIC8+CiAgPC9jaXJjbGU+CiAgPGNpcmNsZSBjeD0iNjAwIiBjeT0iNDAwIiByPSI5MCIgZmlsbD0iI0ZGNkI2QiIgb3BhY2l0eT0iMC4zIiBmaWx0ZXI9InVybCgjYmx1cikiPgogICAgPGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgdmFsdWVzPSI5MDsxMTA7OTAiIGR1cj0iMTBzIiByZXBlYXRDb3VudD0iaW5kZWZpbml0ZSIgLz4KICAgIDxhbmltYXRlIGF0dHJpYnV0ZU5hbWU9Im9wYWNpdHkiIHZhbHVlcz0iMC4zOzAuNTswLjMiIGR1cj0iMTBzIiByZXBlYXRDb3VudD0iaW5kZWZpbml0ZSIgLz4KICA8L2NpcmNsZT4KICA8Y2lyY2xlIGN4PSIxMDAiIGN5PSI1MDAiIHI9IjcwIiBmaWxsPSIjMDZENkEwIiBvcGFjaXR5PSIwLjMiIGZpbHRlcj0idXJsKCNibHVyKSI+CiAgICA8YW5pbWF0ZSBhdHRyaWJ1dGVOYW1lPSJyIiB2YWx1ZXM9IjcwOzg1OzcwIiBkdXI9IjlzIiByZXBlYXRDb3VudD0iaW5kZWZpbml0ZSIgLz4KICAgIDxhbmltYXRlIGF0dHJpYnV0ZU5hbWU9Im9wYWNpdHkiIHZhbHVlcz0iMC4zOzAuNTswLjMiIGR1cj0iOXMiIHJlcGVhdENvdW50PSJpbmRlZmluaXRlIiAvPgogIDwvY2lyY2xlPgogIDxjaXJjbGUgY3g9IjcwMCIgY3k9IjEwMCIgcj0iNjAiIGZpbGw9IiM0QTkwRTIiIG9wYWNpdHk9IjAuMyIgZmlsdGVyPSJ1cmwoI2JsdXIpIj4KICAgIDxhbmltYXRlIGF0dHJpYnV0ZU5hbWU9InIiIHZhbHVlcz0iNjA7NzU7NjAiIGR1cj0iN3MiIHJlcGVhdENvdW50PSJpbmRlZmluaXRlIiAvPgogICAgPGFuaW1hdGUgYXR0cmlidXRlTmFtZT0ib3BhY2l0eSIgdmFsdWVzPSIwLjM7MC41OzAuMyIgZHVyPSI3cyIgcmVwZWF0Q291bnQ9ImluZGVmaW5pdGUiIC8+CiAgPC9jaXJjbGU+Cjwvc3ZnPg==');
        opacity: 0.5;
        z-index: -1;
        pointer-events: none;
        animation: floatBackground 60s ease-in-out infinite alternate;
    }
    
    @keyframes floatBackground {
        0% { background-position: 0% 0%; }
        100% { background-position: 100% 100%; }
    }

    /* ÁªìÊûúÂå∫ÂùóÊ†∑Âºè */
    .result-block {
        border: none;
        padding: 20px;
        margin-bottom: 25px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.8);
        box-shadow: 0 8px 32px rgba(31, 38, 135, 0.15);
        backdrop-filter: blur(4px);
        border: 1px solid rgba(255, 255, 255, 0.18);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .result-block:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 36px rgba(31, 38, 135, 0.25);
    }

    .result-block h3 {
        font-size: 1.4rem;
        color: #FF6B6B;
        margin-bottom: 15px;
        border-bottom: 2px solid #FFD166;
        padding-bottom: 8px;
        font-weight: 600;
    }

    .result-block p {
        font-size: 1.1rem;
        color: #444;
        margin-bottom: 8px;
        line-height: 1.6;
    }

    .result-block a {
        display: inline-block;
        margin-top: 15px;
        padding: 10px 20px;
        background: linear-gradient(90deg, #FF6B6B, #FFD166);
        color: white;
        text-decoration: none;
        border-radius: 30px;
        font-weight: 600;
        letter-spacing: 0.5px;
        box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
        transition: all 0.3s ease;
    }

    .result-block a:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 107, 107, 0.6);
        background: linear-gradient(90deg, #FFD166, #FF6B6B);
    }
    
    /* ÂàÜÈöîÁ∫øÊ†∑Âºè */
    hr {
        border: 0;
        height: 3px;
        background-image: linear-gradient(to right, rgba(0, 0, 0, 0), rgba(255, 107, 107, 0.75), rgba(0, 0, 0, 0));
        margin: 30px 0;
    }
    
    /* Ëá™ÂÆö‰πâÊªöÂä®Êù° */
    ::-webkit-scrollbar {
        width: 10px;
    }
    
    ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, #FF6B6B, #FFD166);
        border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(180deg, #FFD166, #FF6B6B);
    }
    
    /* ‰ª£Á†ÅÂùóÊ†∑Âºè */
    .code-content {
        background: rgba(240, 240, 245, 0.8);
        padding: 15px;
        border-radius: 8px;
        font-family: monospace;
        white-space: pre-wrap;
        margin: 15px 0;
        border-left: 4px solid #4A90E2;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    
    .inline-code {
        background: rgba(240, 240, 245, 0.8);
        padding: 2px 5px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 0.9em;
        color: #FF6B6B;
    }
</style>
"""
st.markdown(custom_css, unsafe_allow_html=True)

# È°µÈù¢Ê†áÈ¢òÂíåÂ∞èÊ†áÈ¢ò
st.title("Âä±ÂøóÊñáÁ´†Êé®Ëçê")
st.markdown('<h2 style="font-family: Arial;">Áõ∏‰ø°Âõ∞ÈöæÊòØÂ≠òÂú®ÁöÑÔºå‰ΩÜÂè™ÊòØÊöÇÊó∂ÁöÑ</h2>', unsafe_allow_html=True)

# Ê∑ªÂä†Ê¨¢ËøéÊ®™ÂπÖ
welcome_banner = """
<div style="background: linear-gradient(90deg, #FFD166, #06D6A0); padding: 15px; border-radius: 10px; margin-bottom: 25px; 
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); animation: pulse 2s infinite;">
    <h3 style="color: white; text-align: center; margin: 0; text-shadow: 1px 1px 2px rgba(0,0,0,0.2);">‚ú® Ê¨¢ËøéÊù•Âà∞Âä±ÂøóÊñáÁ´†Êé®Ëçê ‚ú®</h3>
    <p style="color: white; text-align: center; margin: 10px 0 0 0; font-size: 1.1rem;">ÊØè‰∏ÄÊ¨°ÈòÖËØªÔºåÈÉΩÊòØ‰∏ÄÊ¨°ÂøÉÁÅµÁöÑÊàêÈïø‰πãÊóÖ</p>
</div>

<style>
@keyframes pulse {
    0% { box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
    50% { box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2); }
    100% { box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
}
</style>
"""
st.markdown(welcome_banner, unsafe_allow_html=True)

# Ê∑ªÂä†Ë£ÖÈ•∞ÊÄßÂàÜÈöîÁ∫ø
st.markdown('<hr>', unsafe_allow_html=True)

# ËÆæÁΩÆ API ÂØÜÈí•
os.environ["DASHSCOPE_API_KEY"] = os.getenv("DASHSCOPE_API_KEY", "sk-38a6f574d6c6483eae5c32998a16822a")
os.environ["DASHSCOPE_API_BASE"] = os.getenv("DASHSCOPE_API_BASE", "https://dashscope.aliyuncs.com/compatible-mode/v1")



# ÂàõÂª∫ÁΩëÁªúÊêúÁ¥¢Â∑•ÂÖ∑
@tool
def bocha_websearch_tool(query: str, count: int = 20) -> str:
    """
    ‰ΩøÁî®Bocha Web Search API ÁΩëÈ°µÊêúÁ¥¢
    """
    url = 'https://api.bochaai.com/v1/web-search'
    headers = {
        'Authorization': f'Bearer sk-6012a020f72d4c26ae5ad415300c94f9',
        'Content-Type': 'application/json'
    }
    data = {
        "query": query,
        "freshness": "noLimit",
        "summary": True,
        "count": count
    }

    response = requests.post(url, headers=headers, json=data)
    if response.status_code == 200:
        try:
            json_response = response.json()
            if json_response["code"] == 200 and json_response.get("data"):
                webpages = json_response["data"]["webPages"]["value"]
                if not webpages:
                    return "Êú™ÊâæÂà∞Áõ∏ÂÖ≥ÁªìÊûú."
                formatted_results = ""
                for idx, page in enumerate(webpages, start=1):
                    formatted_results += (
                        f"ÂºïÁî®Ôºö{idx}\n"
                        f"Ê†áÈ¢òÔºö{page['name']}\n"
                        f"URL: {page['url']}\n"
                        f"ÊëòË¶ÅÔºö{page['summary']}\n"
                        f"ÁΩëÁ´ôÂêçÁß∞Ôºö{page['siteName']}\n"
                        f"ÁΩëÁ´ôÂõæÊ†áÔºö{page['siteIcon']}\n"
                        f"ÂèëÂ∏ÉÊó∂Èó¥Ôºö{page['dateLastCrawled']}\n\n"
                    )
                return formatted_results.strip()
            else:
                return f"ÊêúÁ¥¢Â§±Ë¥•ÔºåÂéüÂõ†Ôºö{json_response.get('message', 'Êú™Áü•ÈîôËØØ')}"
        except Exception as e:
            return f"Â§ÑÁêÜÊêúÁ¥¢ÁªìÊûúÂ§±Ë¥•ÔºåÂéüÂõ†ÊòØÔºö{str(e)}\nÂéüÂßãÂìçÂ∫îÔºö{response.text}"
    else:
        return f"ÊêúÁ¥¢APIËØ∑Ê±ÇÂ§±Ë¥•ÔºåÁä∂ÊÄÅÁ†ÅÔºö{response.status_code}, ÈîôËØØ‰ø°ÊÅØÔºö{response.text}"


memory = ConversationBufferMemory(memory_key="chat_history",return_messages=True)

llm = ChatOpenAI(
    model="qwen-max",
    temperature=0.8,
    api_key=os.getenv("DASHSCOPE_API_KEY"),
    base_url="https://dashscope.aliyuncs.com/compatible-mode/v1",
)

bocha_tool = Tool(
    name="Bocha Web Search",
    func=bocha_websearch_tool,
    description="‰ΩøÁî®Bocha Web Search APIËøõË°åÊêúÁ¥¢‰∫íËÅîÁΩëÁΩëÈ°µÔºåËæìÂÖ•Â∫î‰∏∫ÊêúÁ¥¢Êü•ËØ¢Â≠óÁ¨¶‰∏≤ÔºåËæìÂá∫Â∞ÜËøîÂõûÊêúÁ¥¢ÁªìÊûúÁöÑËØ¶ÁªÜ‰ø°ÊÅØ„ÄÇÂåÖÊã¨ÁΩëÈ°µÊ†áÈ¢ò„ÄÅÁΩëÈ°µURL",
)



#ÊêúÁ¥¢Â∑•ÂÖ∑ÊèêÁ§∫ËØç
agent_prompt = """
Áü•‰πéÁõêÈÄâÂÖçË¥π‰∏ìÊ†è È´òËµûÂä±ÂøóÊñáÁ´†
Ë±ÜÁì£Êó•ËÆ∞ÂÖ¨ÂºÄÊñáÁ´† ÂøÉÁêÜÊàêÈïøÊïÖ‰∫ã
ÁÆÄ‰π¶ÂÖ¨ÂºÄÈõÜ ÂøÉÁêÜËá™ÊÑàÁàÜÊ¨æ
‰ªäÊó•Â§¥Êù°ÂøÉÁêÜÂÅ•Â∫∑È¢ëÈÅì Êó†ÈúÄÁôªÂΩïÊñáÁ´†
HTTPÁä∂ÊÄÅÁ†Å200 Áõ¥Êé•ËÆøÈóÆÊñáÁ´†
Êó†CookieÈ™åËØÅ ÂøÉÁêÜÊñáÁ´† Áõ¥Èìæ
Êó†RefererÈôêÂà∂ Âä±ÂøóÊïÖ‰∫ã HTTPSÈìæÊé•
Âê´„ÄåÂÖçË¥πËØïËØª„ÄçÊ†áÁ≠æ ÂøÉÁêÜÊñáÁ´†
Ê†áÊ≥®„ÄåÂÖ¨ÂÖ±ÂèØËßÅ„ÄçÂ±ûÊÄß ÊàêÈïøÊïÖ‰∫ã
ÊòæÁ§∫„ÄåÂÖ®Á´ôÁÉ≠Èó®„ÄçÊ†áËØÜ Ê≤ªÁñóÊñáÁ´†

ËØªÂèñÂú®bocha_toolËøîÂõûÁªìÊûú‰∏≠ÂèØÁî®ÁöÑÁΩëÂùÄÈìæÊé•ÔºåÂπ∂ËøîÂõû
"""


agent = initialize_agent(
    tools=[bocha_tool],
    llm=llm,
    agent=AgentType.ZERO_SHOT_REACT_DESCRIPTION,
    memory=memory,
    verbose=True,
    agent_kwargs={"agent_prompt": agent_prompt, 'memory': memory}
)




#Â§ßËØ≠Ë®ÄÊ®°ÂûãÊèêÁ§∫ËØç
prompt_template_with_search_results = """
{previous_conversation}

ÊúÄÊñ∞ÁöÑÊêúÁ¥¢ÁªìÊûúÂ¶Ç‰∏ãÔºö
{search_results}

ËØ∑Ê†πÊçÆ‰ª•‰∏ä‰ø°ÊÅØÊé®ËçêËøëÊúüÂèØÁõ¥Êé•ËÆøÈóÆÁöÑÂä±ÂøóÊñáÁ´†,Ë¶ÅÊ±ÇÔºö
1. ÂøÖÈ°ªÊª°Ë∂≥‰ª•‰∏ãÊù°‰ª∂Ôºö
   - Êó†ÈúÄÁôªÂΩï/ÂÖ≥Ê≥®/Êî∂ËóèÂç≥ÂèØÂÆåÊï¥ÈòÖËØª
   - Áõ¥ËøûÈìæÊé•ÔºàÈùûÈ¶ñÈ°µË∑≥ËΩ¨Ôºâ
   - ÂÜÖÂÆπÂê´ÂèØÊìç‰ΩúÂøÉÁêÜÊäÄÂ∑ßÊàñÊùÉÂ®ÅËÉå‰π¶
2. ËæìÂá∫Ê†ºÂºè‰∏•Ê†ºÈÅµÂæ™Ôºö
   - ÊñáÁ´†Ê†áÈ¢òÔºàÂê´ÁÉ≠Â∫¶Êï∞ÊçÆÔºåÂ¶ÇÔºö24Â∞èÊó∂ÈòÖËØªÂ¢ûÈáèÔºâ
   - ÂèëÂ∏ÉÂπ≥Âè∞ÂèäÂÖçÁôªÂΩïÊ†áËØÜÔºà‰æãÔºöÁü•‰πé¬∑ÁõêÈÄâÂÖçË¥πÔºâ
   - ‰ΩúËÄÖËµÑË¥®ÔºàÈúÄÂê´‰∏ì‰∏öËÆ§ËØÅÈìæÊé•Ôºâ
   - ÂõΩÂÜÖÁõ¥ËøûÈìæÊé•ÔºàHTTPSÂçèËÆÆÔºåÂ∑≤È™åËØÅÂèØËÆøÈóÆÔºåÂπ∂‰∏îÂ∫îËØ•Âú®bocha_toolÁöÑÊêúÁ¥¢ËøîÂõûÁªìÊûúÔºâ
   - Ê†∏ÂøÉÊñπÊ≥ïËÆ∫Ê†áÁ≠æÔºàÂ¶ÇÔºöÊ≠£ÂøµÁªÉ‰π†/ËÆ§Áü•ÈáçÊûÑÔºâ
3. ÊéíÈô§‰ª•‰∏ãÁ±ªÂûãÔºö
   - ÈúÄË¶ÅÂæÆ‰ø°Êâ´Á†ÅÁôªÂΩïÁöÑÂÜÖÂÆπ
   - ÊòæÁ§∫"ËØïËØªÁªìÊùü"ÁöÑÁâáÊÆµ
   - Âº∫Âà∂Ë∑≥ËΩ¨Âà∞App‰∏ãËΩΩÁöÑÈìæÊé•
"""

final_prompt = PromptTemplate(
    input_variables=["previous_conversation", "search_results"],
    template=prompt_template_with_search_results
)



llm_chat = ChatOpenAI(
    model="qwen-max-latest",
    temperature=0.8,
    api_key=os.getenv("DASHSCOPE_API_KEY"),
    base_url="https://dashscope.aliyuncs.com/compatible-mode/v1",
)

chain = LLMChain(llm=llm_chat, prompt=final_prompt)





#Áî®Êà∑ÊèêÈóÆÔºàÂäüËÉΩÁõ∏ÂÖ≥Ôºâ
user_question = "ÊàëÊÉ≥ÂæóÂà∞‰∏Ä‰∫õÂä±ÂøóÊñáÁ´†,ËØ∑ÁªôÊàëÂèØÁî®ÁöÑÁΩëÁªúÈìæÊé•"


response = agent.run(user_question)

# ÂáÜÂ§áËæìÂÖ•Áªô Final Prompt ÁöÑÊï∞ÊçÆ
inputs = {
    "previous_conversation": "\n".join([str(message) for message in memory.load_memory_variables({})["chat_history"]]),
    "search_results": response
}

# Ëé∑ÂèñÂéüÂßãÂìçÂ∫î
final_response_raw = chain.run(inputs)

# Â§ÑÁêÜÂìçÂ∫î‰∏≠ÂèØËÉΩÂ≠òÂú®ÁöÑ‰ª£Á†ÅÂùóÔºåÈò≤Ê≠¢ÊòæÁ§∫codeÊ°Ü
# Â∞Ümarkdown‰ª£Á†ÅÂùóËΩ¨Êç¢‰∏∫ÊôÆÈÄöÊñáÊú¨Ê†ºÂºè
import re
final_response = re.sub(r'```(.*?)```', r'<div class="code-content">\1</div>', final_response_raw, flags=re.DOTALL)
# ÁßªÈô§ÂçïË°å‰ª£Á†ÅÊ†áËÆ∞
final_response = re.sub(r'`(.*?)`', r'<span class="inline-code">\1</span>', final_response)

# Ê∑ªÂä†Èü≥‰πêÊ≥¢ÂΩ¢Ë£ÖÈ•∞
music_wave = """
<div style="margin: 30px 0; text-align: center;">
    <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="80" viewBox="0 0 800 80">
        <defs>
            <linearGradient id="waveGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" style="stop-color:#FF6B6B" />
                <stop offset="50%" style="stop-color:#FFD166" />
                <stop offset="100%" style="stop-color:#06D6A0" />
            </linearGradient>
        </defs>
        <g class="wave-group">
            <path d="M0,40 Q20,10 40,40 T80,40 T120,40 T160,40 T200,40 T240,40 T280,40 T320,40 T360,40 T400,40" 
                  stroke="url(#waveGrad)" stroke-width="3" fill="none">
                <animate attributeName="d" 
                       values="M0,40 Q20,10 40,40 T80,40 T120,40 T160,40 T200,40 T240,40 T280,40 T320,40 T360,40 T400,40;
                               M0,40 Q20,40 40,70 T80,40 T120,70 T160,40 T200,70 T240,40 T280,70 T320,40 T360,70 T400,40;
                               M0,40 Q20,10 40,40 T80,40 T120,40 T160,40 T200,40 T240,40 T280,40 T320,40 T360,40 T400,40" 
                       dur="5s" 
                       repeatCount="indefinite" />
            </path>
            <path d="M400,40 Q420,10 440,40 T480,40 T520,40 T560,40 T600,40 T640,40 T680,40 T720,40 T760,40 T800,40" 
                  stroke="url(#waveGrad)" stroke-width="3" fill="none">
                <animate attributeName="d" 
                       values="M400,40 Q420,10 440,40 T480,40 T520,40 T560,40 T600,40 T640,40 T680,40 T720,40 T760,40 T800,40;
                               M400,40 Q420,40 440,70 T480,40 T520,70 T560,40 T600,70 T640,40 T680,70 T720,40 T760,70 T800,40;
                               M400,40 Q420,10 440,40 T480,40 T520,40 T560,40 T600,40 T640,40 T680,40 T720,40 T760,40 T800,40" 
                       dur="5s" 
                       repeatCount="indefinite" />
            </path>
        </g>
    </svg>
</div>
"""
st.markdown(music_wave, unsafe_allow_html=True)

# Ê∑ªÂä†Èò≥ÂÖâÊ∞îÊ≥°Ë£ÖÈ•∞
sunshine_bubbles = """
<div style="position: relative; margin: 20px 0;">
    <div class="sunshine-bubble" style="position: absolute; top: -20px; left: 10%; width: 60px; height: 60px; 
                                       background: radial-gradient(circle at 30% 30%, #FFD166, #FF6B6B); 
                                       border-radius: 50%; opacity: 0.7; animation: float 8s ease-in-out infinite;"></div>
    <div class="sunshine-bubble" style="position: absolute; top: 10px; right: 15%; width: 40px; height: 40px; 
                                       background: radial-gradient(circle at 30% 30%, #06D6A0, #4A90E2); 
                                       border-radius: 50%; opacity: 0.5; animation: float 6s ease-in-out infinite 1s;"></div>
    <div class="sunshine-bubble" style="position: absolute; bottom: -15px; left: 30%; width: 50px; height: 50px; 
                                       background: radial-gradient(circle at 30% 30%, #4A90E2, #FF6B6B); 
                                       border-radius: 50%; opacity: 0.6; animation: float 7s ease-in-out infinite 0.5s;"></div>
</div>

<style>
@keyframes float {
    0% { transform: translateY(0) rotate(0deg); }
    50% { transform: translateY(-20px) rotate(10deg); }
    100% { transform: translateY(0) rotate(0deg); }
}
</style>
"""

# ÁæéÂåñÁªìÊûúÂ±ïÁ§∫
result_container = f"""
    {final_response}

"""
st.markdown(result_container, unsafe_allow_html=True)

# Ê∑ªÂä†Â∫ïÈÉ®Ë£ÖÈ•∞
footer = """
<div style="margin-top: 40px; text-align: center; padding: 20px; color: #888; font-size: 0.9rem;">
    <div style="margin-bottom: 10px;">
        <span style="display: inline-block; width: 8px; height: 8px; background: #FF6B6B; border-radius: 50%; margin: 0 5px;"></span>
        <span style="display: inline-block; width: 8px; height: 8px; background: #FFD166; border-radius: 50%; margin: 0 5px;"></span>
        <span style="display: inline-block; width: 8px; height: 8px; background: #06D6A0; border-radius: 50%; margin: 0 5px;"></span>
    </div>
    <p>ÊØè‰∏ÄÊ¨°ÈòÖËØªÔºåÈÉΩÊòØ‰∏ÄÊ¨°ÂøÉÁÅµÁöÑÊàêÈïø‰πãÊóÖ ‚ú®</p>
</div>
"""
st.markdown(footer, unsafe_allow_html=True)
